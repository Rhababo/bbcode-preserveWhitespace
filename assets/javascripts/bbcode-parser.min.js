/* Source code in bbcode-src */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).bbcodeParser={})}(this,(function(t){"use strict";const e=t=>"object"==typeof t&&!!t.tag;function n(t,n,r,s){n.walk((n=>e(n)&&t[n.tag]?t[n.tag](n,r,s):n))}const r={b:t=>({tag:"span",attr:{style:"font-weight: bold","data-rpn-bbcode":""},content:t.content}),font:(t,e)=>(console.log(e),{tag:"span",content:t.content}),nobr:t=>({disableLineBreakConversion:!0,content:t.content})},s=Object.keys(r),o=function t(e,r=n){const s=(t={})=>{s.options=Object.assign(s.options||{},t);const n=(t,n)=>r(e,t,n,s.options);return n.options=s.options,n};return s.extend=n=>t(n(e,s.options),r),s}(r),i="\n",a="\t",c="=",u='"',l=" ",g="[",p="]",h="/",f="\\",d=t=>"object"==typeof t&&!!t.tag,T=(t,e,n)=>Object.keys(t).reduce(e,n),b=t=>d(t)?t.content.reduce(((t,e)=>t+b(e)),0):"string"==typeof t?t.length:0,y=t=>t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(/(javascript|data|vbscript):/gi,"$1%3A"),A=(t,e)=>{const n=typeof e,r={boolean:()=>e?`${t}`:"",number:()=>`${t}="${e}"`,string:()=>`${t}="${y(e)}"`,object:()=>`${t}="${y(JSON.stringify(e))}"`};return r[n]?r[n]():""},k=t=>null==t?"":T(t,((e,n)=>[...e,A(n,t[n])]),[""]).join(" "),m=(t,e)=>{const n=T(r=e,((t,e)=>r[e]===e?r[e]:null),null);var r;if(n){const r=A(t,n),s={...e};delete s[n];return`${r}${k(s)}`}return`${t}${k(e)}`};class N{attr(t,e){return void 0!==e&&(this.attrs[t]=e),this.attrs[t]}append(t){return((t,e)=>{t.content.push(e)})(this,t)}get length(){return b(this)}toTagStart({openTag:t=g,closeTag:e=p}={}){return`${t}${m(this.tag,this.attrs)}${e}`}toTagEnd({openTag:t=g,closeTag:e=p}={}){return`${t}${h}${this.tag}${e}`}toTagNode(){return new N(this.tag.toLowerCase(),this.attrs,this.content)}toString({openTag:t=g,closeTag:e=p}={}){const n=0===this.content.length,r=this.content.reduce(((n,r)=>n+r.toString({openTag:t,closeTag:e})),""),s=this.toTagStart({openTag:t,closeTag:e});return n?s:`${s}${r}${this.toTagEnd({openTag:t,closeTag:e})}`}constructor(t,e,n){this.tag=t,this.attrs=e,this.content=Array.isArray(n)?n:[n]}}N.create=(t,e={},n=[])=>new N(t,e,n),N.isOf=(t,e)=>t.tag===e;const $="type",x="value",v="line",w=t=>t&&void 0!==t[x]?t[x]:"",C=t=>w(t).charCodeAt(0)===h.charCodeAt(0);class L{isEmpty(){return isNaN(this[$])}isText(){return!(!(t=this)||void 0===t[$]||5!==t[$]&&6!==t[$]&&1!==t[$]);var t}isTag(){return!(!(t=this)||void 0===t[$])&&2===t[$];var t}isAttrName(){return!(!(t=this)||void 0===t[$])&&3===t[$];var t}isAttrValue(){return!(!(t=this)||void 0===t[$])&&4===t[$];var t}isStart(){return!C(this)}isEnd(){return C(this)}getName(){return(t=>{const e=w(t);return C(t)?e.slice(1):e})(this)}getValue(){return w(this)}getLine(){return(t=this)&&t[v]||0;var t}getColumn(){return(t=this)&&t.row||0;var t}toString(){return(t=>{let e=g;return e+=w(t),e+=p,e})(this)}constructor(t,e,n,r){this[$]=Number(t),this[x]=String(e),this[v]=Number(n),this.row=Number(r)}}function E(t,e){const n={pos:0,len:t.length},r=()=>n.len>n.pos,s=(t=1,r)=>{n.pos+=t,e&&e.onSkip&&!r&&e.onSkip()},o=()=>t[n.pos];this.skip=s,this.hasNext=r,this.getCurr=o,this.getRest=()=>t.substring(n.pos),this.getNext=()=>{const e=n.pos+1;return e<=t.length-1?t[e]:null},this.getPrev=()=>{const e=n.pos-1;return void 0!==t[e]?t[e]:null},this.isLast=()=>n.pos===n.len,this.includes=e=>t.indexOf(e,n.pos)>=0,this.grabWhile=(e,i)=>{let a=0;if(r())for(a=n.pos;r()&&e(o());)s(1,i);return t.substring(a,n.pos)},this.grabN=(e=0)=>t.substring(n.pos,n.pos+e),this.substrUntilChar=e=>{const{pos:r}=n,s=t.indexOf(e,r);return s>=0?t.substring(r,s):""}}const S=(t,e)=>new E(t,e);function O(t=[]){const e=t;this.push=t=>e.push(t),this.toArray=()=>e,this.getLast=()=>Array.isArray(e)&&e.length>0&&void 0!==e[e.length-1]?e[e.length-1]:null,this.flushLast=()=>!!e.length&&e.pop()}const j=(t=[])=>new O(t);function W(t,e={}){const n=0,r=1,s=2,o=0,d=1,T=2;let b=0,y=0,A=-1,k=n,m=o,N="";const $=new Array(Math.floor(t.length)),x=e.openTag||g,v=e.closeTag||p,w=!!e.enableEscapeTags,C=e.contextFreeTags||[],E=e.onToken||(()=>{}),O=[v,x,u,f,l,a,c,i,"!"],j=[x,l,a,i],W=[l,a],V=[c,l,a],B=t=>O.indexOf(t)>=0,P=t=>t===i,z=t=>W.indexOf(t)>=0,F=t=>-1===j.indexOf(t),R=t=>V.indexOf(t)>=0,U=t=>t===x||t===v||t===f,q=t=>t===f,I=()=>{y++},J=t=>((t,e)=>{for(;t.charAt(0)===e;)t=t.substring(1);for(;t.charAt(t.length-1)===e;)t=t.substring(0,t.length-1);return t})(t,u).replace(f+u,u),M=(t,e)=>{""!==N&&e&&(N=""),""===N&&C.includes(t)&&(N=t)},D=S(t,{onSkip:I});function G(t,e){const n=((t,e,n=0,r=0)=>new L(t,e,n,r))(t,e,b,y);E(n),A+=1,$[A]=n}function H(t,e){if(m===d){const e=t=>!(t===c||z(t)),n=t.grabWhile(e),r=t.isLast(),s=t.getCurr()!==c;return t.skip(),r||s?G(4,J(n)):G(3,n),r?o:s?d:T}if(m===T){let n=!1;const r=r=>{const s=r===u,o=t.getPrev(),i=t.getNext(),a=o===f,l=i===c,g=z(r),p=z(i);return!(!n||!R(r))||!!(!s||a||(n=!n,n||l||p))&&(!!e||!1===g)},s=t.grabWhile(r);return t.skip(),G(4,J(s)),t.isLast()?o:d}const n=t.grabWhile((e=>!(e===c||z(e)||t.isLast())));if(G(2,n),M(n),t.skip(),e)return T;return t.includes(c)?d:T}function K(){const t=D.getCurr(),e=D.getNext();D.skip();const r=D.substrUntilChar(v),o=0===r.length||r.indexOf(x)>=0;if(B(e)||o||D.isLast())return G(1,t),n;const i=-1===r.indexOf(c),a=r[0]===h;if(i||a){const t=D.grabWhile((t=>t!==v));return D.skip(),G(2,t),M(t,a),n}return s}function Q(){const t=D.grabWhile((t=>t!==v),!0),e=S(t,{onSkip:I}),r=e.includes(l);for(m=o;e.hasNext();)m=H(e,!r);return D.skip(),n}function X(){if(P(D.getCurr()))return G(6,D.getCurr()),D.skip(),y=0,b++,n;if(z(D.getCurr())){return G(5,D.grabWhile(z)),n}if(D.getCurr()===x){if(N){const t=x.length+1+N.length,e=`${x}${h}${N}`;if(D.grabN(t)===e)return r}else if(D.includes(v))return r;return G(1,D.getCurr()),D.skip(),n}if(w){if(q(D.getCurr())){const t=D.getCurr(),e=D.getNext();return D.skip(),U(e)?(D.skip(),G(1,e),n):(G(1,t),n)}const t=t=>F(t)&&!q(t);return G(1,D.grabWhile(t)),n}return G(1,D.grabWhile(F)),n}return{tokenize:function(){for(k=n;D.hasNext();)switch(k){case r:k=K();break;case s:k=Q();break;default:k=X()}return $.length=A+1,$},isTokenNested:function(e){const n=x+h+e.getValue();return t.indexOf(n)>-1}}}const V=(t,e={})=>{const n=e,r=n.openTag||g,s=n.closeTag||p;let o=null;const i=j(),a=j(),c=j(),u=j(),l=new Set,h=()=>{c.flushLast()&&u.flushLast()},f=t=>{const e=(()=>{const t=a.getLast();return t&&Array.isArray(t.content)?t.content:i.toArray()})();var o;Array.isArray(e)&&(d(t)?(o=t.tag,!n.onlyAllowTags||!n.onlyAllowTags.length||n.onlyAllowTags.indexOf(o)>=0?e.push(t.toTagNode()):(e.push(t.toTagStart({openTag:r,closeTag:s})),t.content.length&&(t.content.forEach((t=>{e.push(t)})),e.push(t.toTagEnd({openTag:r,closeTag:s}))))):e.push(t))},T=t=>{h();const e=N.create(t.getValue()),n=(t=>{const e=t.getValue();return!l.has(e)&&o.isTokenNested&&o.isTokenNested(t)?(l.add(e),!0):l.has(e)})(t);c.push(e),n?a.push(e):f(e)},b=t=>{t.isStart()&&T(t),t.isEnd()&&(t=>{h();const e=a.flushLast();if(e)f(e);else if("function"==typeof n.onError){const e=t.getValue(),r=t.getLine(),s=t.getColumn();n.onError({message:`Inconsistent tag '${e}' on line ${r} and column ${s}`,tagName:e,lineNumber:r,columnNumber:s})}})(t)},y=t=>{const e=c.getLast(),n=t.getValue(),r=(s=t,Boolean(l.has(s)));var s;if(e)if(t.isAttrName())u.push(n),e.attr(u.getLast(),"");else if(t.isAttrValue()){const t=u.getLast();t?(e.attr(t,n),u.flushLast()):e.attr(n,n)}else t.isText()?r?e.append(n):f(n):t.isTag()&&f(t.toString());else t.isText()?f(n):t.isTag()&&f(t.toString())};return o=(e.createTokenizer?e.createTokenizer:W)(t,{onToken:t=>{t.isTag()?b(t):y(t)},openTag:r,closeTag:s,onlyAllowTags:n.onlyAllowTags,contextFreeTags:n.contextFreeTags,enableEscapeTags:n.enableEscapeTags}),o.tokenize(),i.toArray()},B=t=>"object"==typeof t,P=t=>"boolean"==typeof t;function z(t,e){const n=t;if(Array.isArray(n))for(let t=0;t<n.length;t++)n[t]=z(e(n[t]),e);else n&&B(n)&&n.content&&z(n.content,e);return n}function F(t,e){return typeof t==typeof e&&(B(t)&&null!==t?Array.isArray(t)?t.every((t=>[].some.call(e,(e=>F(t,e))))):Object.keys(t).every((n=>{const r=e[n],s=t[n];return B(s)&&null!==s&&null!==r?F(s,r):P(s)?s!==(null===r):r===s})):t===e)}function R(t,e){return Array.isArray(t)?z(this,(n=>{for(let r=0;r<t.length;r++)if(F(t[r],n))return e(n);return n})):z(this,(n=>F(t,n)?e(n):n))}function U(t){return z(this,t)}const q="/>",I="</",J="<",M=">",D=(t,{stripTags:e=!1}={})=>[].concat(t).reduce(((t,n)=>t+((t,{stripTags:e=!1})=>{if(!t)return"";const n=typeof t;return"string"===n||"number"===n?t:"object"===n?!0===e?D(t.content,{stripTags:e}):null===t.content?[J,t.tag,k(t.attrs),q].join(""):[J,t.tag,k(t.attrs),M,D(t.content),I,t.tag,M].join(""):Array.isArray(t)?D(t,{stripTags:e}):""})(n,{stripTags:e})),""),G=D,H=t=>{const e=t;if(Array.isArray(e))for(let t=0;t<e.length;t++){const n=H(e[t]);Array.isArray(n)?(e.splice(t,1,...n),t+=n.length):e[t]=n}else if(e&&"object"==typeof e&&e.content){if(e.disableLineBreakConversion)return e.tag?e:e.content;H(e.content)}return e===i?{tag:"br",content:null}:e},K={onlyAllowTags:[...s,"nobr"],enableEscapeTags:!0,onError:t=>console.warn(t.message,t.lineNumber,t.columnNumber),data:[]};t.RpNBBCode=t=>function(t){const e="function"==typeof t?[t]:t||[];let n={skipParse:!1};return{process(t,r){n=r||{};const s=n.parser||V,o=n.render,i=n.data||null;if("function"!=typeof s)throw new Error('"parser" is not a function, please pass to "process(input, { parser })" right function');let a=n.skipParse?t||[]:s(t,n);const c=a;return a.messages=[],a.options=n,a.walk=U,a.match=R,e.forEach((t=>{a=t(a,{parse:s,render:o,iterate:z,match:R,data:i})||a})),{get html(){if("function"!=typeof o)throw new Error('"render" function not defined, please pass to "process(input, { render })"');return o(a,a.options)},tree:a,raw:c,messages:a.messages}}}}([o(),t=>H(t)]).process(t,{render:G,...K})}));
